name: Deploy Prod to ECR and EC2

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-main
  cancel-in-progress: false

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:prod-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-to-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to EC2 via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.PROD_EC2_INSTANCE_ID }}" \
            --comment "Deploying Prod Spring Boot via SSM" \
            --parameters 'commands=[
              "set -e",
              "trap \"rm -f /tmp/playprobie-prod/.env\" EXIT",
              "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}",
              "docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}",
              "docker stop playprobie-server-prod || true",
              "docker rm playprobie-server-prod || true",
              "docker image prune -af --filter until=168h",
              "mkdir -p /tmp/playprobie-prod",
              "echo \"SPRING_PROFILES_ACTIVE=prod\" > /tmp/playprobie-prod/.env",
              "echo \"DB_URL=${{ secrets.PROD_DB_URL }}\" >> /tmp/playprobie-prod/.env",
              "echo \"DB_USERNAME=${{ secrets.PROD_DB_USER }}\" >> /tmp/playprobie-prod/.env",
              "echo \"DB_PASSWORD=${{ secrets.PROD_DB_PASS }}\" >> /tmp/playprobie-prod/.env",
              "echo \"CORS_ALLOWED_ORIGINS=${{ secrets.PROD_CORS_ALLOWED_ORIGINS }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_REGION=${{ secrets.PROD_AWS_REGION }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_ACCESS_KEY=${{ secrets.PROD_AWS_ACCESS_KEY_ID }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_SECRET_KEY=${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_S3_REGION=${{ secrets.PROD_S3_REGION }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_S3_BUCKET_NAME=${{ secrets.PROD_AWS_S3_BUCKET_NAME }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_S3_ROLE_ARN=${{ secrets.PROD_AWS_S3_ROLE_ARN }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_GAMELIFT_REGION=${{ secrets.PROD_AWS_GAMELIFT_REGION }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AWS_GAMELIFT_ROLE_ARN=${{ secrets.PROD_AWS_GAMELIFT_ROLE_ARN }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AI_SERVER_URL=${{ secrets.PROD_AI_SERVER_URL }}\" >> /tmp/playprobie-prod/.env",
              "echo \"AI_CLIENT_READ_TIMEOUT=${{ secrets.AI_CLIENT_READ_TIMEOUT }}\" >> /tmp/playprobie-prod/.env",
              "echo \"JWT_SECRET=${{ secrets.PROD_JWT_SECRET }}\" >> /tmp/playprobie-prod/.env",
              "chmod 600 /tmp/playprobie-prod/.env",
              "docker run -d --name playprobie-server-prod -p 8081:8080 --env-file /tmp/playprobie-prod/.env ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}",
              "echo \"Waiting for application to start...\"",
              "sleep 30",
              "curl -f http://localhost:8081/actuator/health || exit 1",
              "echo \"Deployment successful!\""
            ]' \
            --region ${{ env.AWS_REGION }} \
            --query 'Command.CommandId' \
            --output text)
          
          echo "SSM Command ID: $COMMAND_ID"
          
          echo "Waiting for SSM command to complete..."
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.PROD_EC2_INSTANCE_ID }} || true
            
          STATUS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.PROD_EC2_INSTANCE_ID }} \
            --query 'Status' \
            --output text)
            
          echo "Command Status: $STATUS"
          
          if [ "$STATUS" != "Success" ]; then
            echo "::error::Deployment failed with status: $STATUS"
            aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ secrets.PROD_EC2_INSTANCE_ID }} \
              --query 'StandardErrorContent' \
              --output text
            exit 1
          fi
          
          echo "âœ… Deployment completed successfully!"
